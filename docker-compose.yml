services:
  # ==========================================
  # HONEYPOTS
  # ==========================================
  
  # SSH Honeypot
  ssh-honeypot:
    build: ./ssh-honeypot
    container_name: honeypot-ssh
    hostname: srv-prod-01
    restart: unless-stopped
    ports:
      - "222:222"  # SSH honeypot
    volumes:
      - ./logs/ssh-honeypot:/app/logs
    networks:
      - honeypot-net
    labels:
      - "honeypot.type=ssh"
      - "honeypot.name=ssh-honeypot"

  # FTP Honeypot (Dionaea - FTP only)
  dionaea:
    image: dinotools/dionaea:latest
    container_name: honeypot-ftp
    hostname: file-server-02
    restart: unless-stopped
    ports:
      - "211:21"      # FTP
    volumes:
      - ./logs/dionaea:/opt/dionaea/var/log
      - ./data/dionaea:/opt/dionaea/var/dionaea
    networks:
      - honeypot-net
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    labels:
      - "honeypot.type=ftp"
      - "honeypot.name=dionaea"

  # Dionaea Log Parser
  dionaea-parser:
    image: python:3.11-alpine
    container_name: dionaea-parser
    restart: unless-stopped
    volumes:
      - ./logs/dionaea:/opt/dionaea/var/log:ro
      - ./logs/dionaea:/logs/dionaea
      - ./scripts:/scripts:ro
    command: sh /scripts/parse-dionaea-loop.sh
    networks:
      - honeypot-net
    depends_on:
      - dionaea
    labels:
      - "monitoring.component=log-parser"
      - "honeypot.name=dionaea"

  # Custom Web Honeypot
  web-honeypot:
    build: ./web-honeypot
    container_name: honeypot-web
    hostname: web-app-03
    restart: unless-stopped
    ports:
      - "80:80"  # Web honeypot
    volumes:
      - ./logs/web-honeypot:/app/logs
    environment:
      - LOG_LEVEL=INFO
    networks:
      - honeypot-net
    labels:
      - "honeypot.type=web"
      - "honeypot.name=web-honeypot"

  # ==========================================
  # LOG SERVER
  # ==========================================

  # Python server - Converts NDJSON logs to JSON arrays for Grafana
  log-server:
    build: ./log-server
    container_name: honeypot-log-server
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/logs:ro
    networks:
      - honeypot-net
    labels:
      - "monitoring.component=log-server"

  # ==========================================
  # VISUALIZATION
  # ==========================================

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:10.2.2
    container_name: honeypot-grafana
    restart: unless-stopped
    user: "0:0"  # Run as root to avoid permission issues
    ports:
      - "3000:3000"
    volumes:
      - ./logs:/var/log/honeypot:ro
      - ./dashboards:/var/lib/grafana/dashboards:ro
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=honeypot123
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,marcusolsson-json-datasource
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=marcusolsson-json-datasource
      - GF_PATHS_DATA=/var/lib/grafana
      - GF_PATHS_LOGS=/var/log/grafana
      - GF_PATHS_PLUGINS=/var/lib/grafana/plugins
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    networks:
      - honeypot-net
    labels:
      - "monitoring.component=visualization"

networks:
  honeypot-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  grafana-data:
